<div class="row row-custom">
  <div class="register-form">
    <div class="alert-box round alert _hidden">
      <span></span>
      <a class="close">x</a>
    </div>
    <div class="sign-up-form">
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), :html => {:class => 'form-registration'}) do |f| %>
        <%= devise_error_messages! %>

        <div class="form-group">
          <%= f.label :username %><br />
          <%= f.text_field :username, autofocus: true, class: 'register-form__username' %>
        </div>

        <div class="form-group">
          <%= f.label :email %><br />
          <%= f.email_field :email, class: 'register-form__email'%>
        </div>

        <div class="form-group b-tooltip">
          <%= f.label :password %>
          <span class="b-tooltip__element">?
            <div class="b-tooltip__content">
              <%= t('devise.registrations.new.min_password_length') %>
            </div>
          </span>
          <br />
          <%= f.password_field :password, autocomplete: "off", class: 'register-form__password' %>
        </div>

        <div class="form-group">
          <%= f.label t('devise.registrations.new.repeat_password') %><br />
          <%= f.password_field :password_confirmation, autocomplete: "off", class: 'register-form__password-confirm' %>
        </div>

        <%= hidden_field_tag :authenticity_token, form_authenticity_token, class: 'register-form__token' %>
        <button type="submit" class="btn btn-primary normal-button"><%= t('devise.registrations.new.sign_up') %></button>
      <% end %>
    </div>
  </div>
</div>


<script>
    $(document).ready(function() {
        $document
            .on('click.hideAlert', '.alert-box .close', function() {
                $('.alert-box').fadeOut(1000);
            })
            .on('submit.login', 'form.form-registration', function(e) {
                e.preventDefault();

                var url = '<%= registration_path(resource_name) %>';
                var registerData = {
                    utf8: "âœ“",
                    authenticity_token: $('.sign-in-form__token').val(),
                    user: {
                        username: $('.register-form__username').val(),
                        email: $('.register-form__email').val(),
                        password: $('.register-form__password').val(),
                        password_confirmation: $('.register-form__password-confirm').val()
                    }
                }

                $.ajax({
                    type: 'POST',
                    url: url,
                    dataType: 'JSON',
                    data: registerData,
                    success: function() {
                        sessionStorage.setItem('showMessageAfterRegister', JSON.stringify(true))
                        window.location.replace(window.location.origin + '/home')
                    },
                    error: function(e) {
                        var errors = JSON.parse(e.responseText).errors,
                            error = '';

                        for (var errorType in errors) {
                            if (errors[errorType].length) {
                                error += errorType[0].toUpperCase() + errorType.slice(1) + ' ' + errors[errorType][0] + ' <br /> ';
                            }
                        }

                        $('.alert-box').css({ display: 'block' });
                        $('.alert-box').removeClass('_hidden');
                        $('.alert-box span').html(error);
                        var timeout = setTimeout(function() {
                            $('.alert-box').fadeOut(1000);
                            clearTimeout(timeout);
                        }, 10000);
                    }
                })


            })
    })
</script>
