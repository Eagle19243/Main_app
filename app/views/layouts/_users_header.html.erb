<div class="s-header__wrapper">
  <div class="s-header__left">
    <div class="s-header__logo">
      <% if user_signed_in? %>
          <!-- For signed users, we should still this to redirect to root path as we have only dummy projects -->
          <%= link_to root_path do %>
            WeServe.io
            <small>Beta</small>
          <% end %>
      <% else %>
          <%= link_to root_path do %>
            WeServe.io
            <small>Beta</small>
          <% end %>
      <% end %>
    </div>

    <a type="button" class="btn-root _small hidden-mobile header-align" data-modal="#startProjectModal">Start a Project</a>
    <div class="header-dropdown">
        <div class="header-dropdown__title js-dropdown">Explore</div>
        <ul class="header-dropdown__list js-dropdown-list">
            <li class="header-dropdown__item">
                <a class="projects-link" href="<%= projects_path %>">Active Projects</a>
            </li>
            <li class="header-dropdown__item">
                <a href="<%= projects_path %>">About the platform</a>
            </li>
            <li class="header-dropdown__item">
                <a href="<%= projects_path %>">Improve the platform</a>
            </li>
            <li class="header-dropdown__item">
                <a href="<%= projects_path %>">Knowledge base</a>
            </li>
            <li class="header-dropdown__item">
                <a href="<%= projects_path %>">FAQs</a>
            </li>
        </ul>
    </div>
    <!--<%= link_to 'Active Projects', projects_path, data: {no_turbolink: true}, :class => "projects-link hidden-mobile" %>-->

  </div>

  <div class="s-header__right">
    <div class="search-box-wrapper show-desktop">
      <%= form_tag projects_user_search_path, :method => :post, :remote => true, :id => 'search-form', :class => "search-project-box" do %>
          <%= autocomplete_field_tag :title, nil, autocomplete_user_search_projects_path, :placeholder => "Search Causes, Places, or Keyword" %>
          <button name="" class="btn-search btn-reset">
              <svg focusable="false" version="1.1" class="svg-search">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#svg-search"></use>
              </svg>
          </button>
      <% end %>
    </div>

    <%= link_to group_messages_path, data: {no_turbolink: true}, :class => 'btn-reset btn-notification' do %>
      <svg focusable="false" version="1.1" class="svg-envelope">
          <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#svg-envelope"></use>
      </svg>

    <% end %>

    <div class="dropdown notify-dropdown show-desktop">
      <a class="dropdown-toggle btn-reset btn-bell" type="button" data-toggle="dropdown">
          <div class="btn-bell__wrapper">
              <svg focusable="false" version="1.1" class="svg-bell">
                  <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#svg-bell"></use>
              </svg>

              <% if current_user.notifications.unread.count > 0 %>
                <span class="btn-bell__counter"><%= current_user.notifications.unread.count %></span>
              <% end %>
          </div>
      </a>

      <div class="b-dropdown">
        <div class="b-dropdown__count">
          Notifications&nbsp;
          <span class="count"><%= current_user.notifications.unread.count %></span>
        </div>

        <ul class="l-dropdown">
          <% if current_user.notifications.unread.count == 0 %>
            <li class="l-dropdown__item">
              <span class="l-dropdown__action">No new notification</span>
            </li>
          <% else %>
            <% current_user.notifications.unread.each do |n| %>
              <% source_model = n.source_model %>
              <% source_model ||= n.archived_source_model %>

              <% if source_model.present? %>
                <% if n.user_id == current_user.id && n.origin_user_id != current_user.id %>
                  <li class="l-dropdown__item">
                    <div class="l-dropdown__item-wrapper">
                      <% if n.created_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Created Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")}"%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "You have created a project named "%>
                          <span><%= "#{source_model.title}"%></span>
                        </p>
                      <% elsif n.updated_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Updated Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "You have updated a project named "%>
                          <span><%= "#{source_model.title}"%></span>
                        </p>
                      <% elsif n.follow_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Follow Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><span>You are now following project
                          <span><%= "#{source_model.title}"%></span>
                        </p>
                      <% elsif n.rejected_task? %>
                        <li class="l-dropdown__item">
                          <div class="l-dropdown__item-wrapper">
                              <div class="notification-item">
                                <span class="l-dropdown__action">Task Rejection</span>
                                <span class="l-dropdown__date">
                                  <%= "#{n.created_at.strftime(" %b %d")}"%>
                                </span>
                              </div>
                              <p class="l-dropdown__text">You have rejected a task named<span><%= " #{source_model.title}"%></span></p>
                          </div>
                        </li>
                      <% elsif n.suggested_task? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Task Suggestion</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "You have a suggested task "%><span><%= "#{source_model.title}"%></span><%= " for "%><span><%= "#{source_model.project.title}."%></span><%=" It's waiting for approval."%></p>

                      <% elsif n.accept_task? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Task Accepted</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "Your task "%>
                          <span><%= "#{source_model.title}"%></span>
                          <%= " has been approved."%>
                        </p>
                      <% elsif n.apply_request? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Team Request</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text">
                          <span><%= "#{n.origin_user.name} applied as #{source_model.request_type.titleize} for project #{source_model.project.title}"%></span>
                        </p>
                      <% elsif n.pending_do_request? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Task Request</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")}"%>
                          </span>
                        </div>
                        <p class="l-dropdown__text">
                          <span><%= "#{n.origin_user.name} requested to do this task #{source_model.task.title}. Their cover letter is: #{source_model.application}" %></span>
                        </p>
                      <% end %>
                    </div>
                  </li>
                <% elsif n.origin_user_id == current_user.id%>
                  <li class="l-dropdown__item">
                    <div class="l-dropdown__item-wrapper">
                      <% if n.suggested_task? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Suggested Task</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")}"%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "Your task "%>
                          <span><%= "#{source_model.title}"%></span>
                          <%= " for "%>
                            <span><%= "#{source_model.project.title}"%></span><%= " has been suggested to "%><span><%= "#{n.origin_user.name}."%></span>
                          <%=" It's waiting for approval."%>
                        </p>
                      <% elsif n.follow_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Follow Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><span><%= "#{n.origin_user.name}"%></span><%= " followed "%>
                          <span><%= "#{source_model.title}"%></span>
                        </p>
                      <% end %>
                    </div>
                  </li>
                <% else %>
                  <li class="l-dropdown__item">
                    <div class="l-dropdown__item-wrapper">
                      <% if n.created_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Created Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")}"%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "#{n.user.name} have created project named "%><span><%= "#{source_model.title}"%></span></p>
                      <% elsif n.follow_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Follow Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")} "%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "#{n.user.name} follows project "%><span><%= "#{source_model.title}"%></span></p>
                      <% elsif n.updated_project? %>
                        <div class="notification-item">
                          <span class="l-dropdown__action">Updated Project</span>
                          <span class="l-dropdown__date">
                            <%= "#{n.created_at.strftime(" %b %d")}"%>
                          </span>
                        </div>
                        <p class="l-dropdown__text"><%= "#{n.user.name} have updated project named "%><span><%= "#{source_model.title}"%></span></p>
                      <% end %>
                    </div>
                  </li>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </ul>
        <div class="b-dropdown__link">
          <%= link_to 'See All Notifications', notifications_path %>
        </div>
      </div>
    </div>

    <div class="dropdown user-dropdown show-desktop">
      <a class="dropdown-toggle pr-user" type="button" data-toggle="dropdown">
        <% if current_user.picture? %>
            <%= image_tag(current_user.picture, size: "30x30", class: "pr-user__img", data: {object_fit:"cover"}) %>
        <% else %>
            <%= gravatar_for_user(current_user) %>
        <% end %>
        <span class="user-dropdown__name">
          <span>Hi,&nbsp;<%= current_user.name %>!&nbsp;&nbsp;</span>

          <svg focusable="false" version="1.1" class="svg-arrow-down">
              <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#svg-arrow-down"></use>
          </svg>
        </span>
      </a>
      <ul class="dropdown-menu">
        <li><%= link_to 'My Profile', user_path(current_user) %></li>
        <li><%= link_to 'My Projects', my_projects_path %></li>
        <li><a href="/users/<%= current_user.id %>/my_wallet">My Wallet</a></li>
        <% if current_user.admin? %>
            <li><%= link_to 'Archived Projects', archived_projects_path %></li>
        <% end %>
        <li class="border-top">
          <%= link_to 'Logout', destroy_user_session_path, :method => 'delete' %>
        </li>
      </ul>
    </div>

    <a href="javascript:void(0)" class="btn-mobile hamburger show-tablet">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </a>
    <a href="javascript:void(0)" class="btn-mobile cross">
      <i class="fa fa-times" aria-hidden="true"></i>
    </a>

  </div>
</div>


<div class="mobile-menu display-none">
  <ul class="mobile-menu-list">
    <li class="border-bottom show-mobile">
      <a data-modal="#startProjectModal">Start a Project</a>
    </li>
    <li class="border-bottom show-mobile">
      <%= link_to 'Active Projects', projects_path, data: {no_turbolink: true} %>
    </li>

    <li class="border-bottom">
      <%= form_tag projects_user_search_path, :method => :post, :remote => true, :id => 'search-form', :class => "search-project-box" do %>
          <button type="button" name="" type="submit">
            <i class="fa fa-search"></i>
          </button>
          <%= autocomplete_field_tag :title, nil, autocomplete_user_search_projects_path, :placeholder => "Search Causes, Places, or Keyword" %>
      <% end %>
    </li>

    <li class="border-bottom">
      <a href="/notifications">
        <div class="badge-wrap">
          <i class="fa fa-bell-o" aria-hidden="true"></i>
          <span class="count"><%= current_user.notifications.unread.count %></span>
          <span>My Notifications</span>
        </div>
      </a>
    </li>

    <li class="border-bottom">
      <a href="/group_messages">
        <i class="fa fa-envelope-o" aria-hidden="true"></i>
        <span>Message</span>
      </a>
    </li>

    <li class="border-bottom mobile-user-menu">
      <a href="javascript:void(0)" id="btnUserToggle" class="border-bottom">
        <% if current_user.picture? %>
          <%= image_tag(current_user.picture, size: "30x30") %>
        <% else %>
          <%= gravatar_for_user(current_user) %>
        <% end %>
        <span>Hi,&nbsp;<%= current_user.name %>!&nbsp;&nbsp;
          <i class="fa fa-chevron-right" aria-hidden="true"></i>
          <i class="fa fa-chevron-down" aria-hidden="true"></i>
        </span>
      </a>
      <div class="mobile-user-submenu">
        <ul>
          <li><%= link_to 'My Profile', user_path(current_user) %></li>
          <li><%= link_to 'My Projects', my_projects_path(current_user) %></li>
          <li><a href="/users/<%= current_user.id %>/my_wallet">My wallet</a></li>
        </ul>
      </div>
    </li>

    <li>
      <%= link_to 'Logout', destroy_user_session_path, :method => 'delete' %>
    </li>
  </ul>
</div>


<script>

$(document).ready(function() {
    var $dropdown = $('.js-dropdown');

    $(document)
        .on('click.dropdownToggle', '.js-dropdown', function() {
            $(this).toggleClass('_active');
            $(this).siblings('.js-dropdown-list').toggleClass('_active');
        })
        .on('click.hideDropdown', function(e) {
            if (!$(e.target).closest('.js-dropdown-list').length && !$(e.target).closest('.js-dropdown').length) {
                hideDropdowns();
            }
        })

    $(window).on('resize', function() {
        hideDropdowns();
    })

    function hideDropdowns() {
        $dropdown.removeClass('_active');
        $('.js-dropdown-list').removeClass('_active');
    }
})

</script>